!function(a,b){"function"==typeof define&&define.amd?define(["underscore","jquery"],function(c,d){var e=b(a,c,d);return e}):a.smartPicker=b(a,a._,a.jQuery||a.Zepto||a.$)}(this,function(a,b,c){function d(a,b){function d(){i(u),m()}function e(){var a=[];return p.find("option").each(function(){var b=c(this),d=b.text(),e=b.attr("value"),f="selected"==b.attr("selected")?!0:!1,g={text:d,value:e,selected:f};a.push(g)}),a}function f(a){for(var b=[],c=0,d=u.length;d>c;c++){var e=u[c];e.selected=-1===a.indexOf(u[c].value)?!1:!0,b.push(e)}return b}function g(){D.val(""),n(),m(),C.addClass(s.class_popup_visible),D.focus(),c.isFunction(b.onOpen)&&b.onOpen(k())}function h(){D.blur(),C.removeClass(s.class_popup_visible),m(),c.isFunction(b.onClose)&&b.onClose(k())}function i(a){E.html("");for(var b=0,d=a.length;d>b;b++){var e=a[b].text,f=a[b].value,g=a[b].selected,h=c("<div class='"+s.class_option+"'></div>").text(e).attr("data-value",f);g!==!1&&h.addClass(s.class_option_checked),h.click(function(){j(c(this))}),E.append(h)}}function j(a,d){a.toggleClass(s.class_option_checked);for(var e=d||a.attr("data-value"),f=0,g=u.length;g>f;f++)if(u[f].value==e){u[f].selected=!u[f].selected;break}D.val(""),n(),m();var h=k(!0);l(h),c.isFunction(b.onChange)&&b.onChange(k())}function k(a){for(var b=[],c=0,d=u.length;d>c;c++){var e=u[c];u[c].selected===!0&&b.push(a?e.value:e)}return b}function l(a){p.val(a)}function m(){var a=k(),c=x;if(0===a.length)D.attr("placeholder",""),B.html(c);else{var d=b.maxDisplay;if(c=a.length,c+=" selected",a.length>d)B.html(c);else{for(var e="",f=0,g=a.length;g>f;f++)e+=a[f].text,g-1>f&&(e+=", ");B.html(e)}D.attr("placeholder",c+" (total of "+u.length+")")}}function n(){var a=D.val();o(a)}function o(a){a=a.toLowerCase();for(var b=[],c=0,d=u.length;d>c;c++){var e=u[c],f=e.text.toLowerCase();-1!==f.indexOf(a)&&b.push(e)}i(b)}var p=c(a);if("select"===p.prop("tagName").toLowerCase()){var q="select-mult",r=q+"-",s={class_selected:r+"selected",class_popup:r+"popup",class_popup_visible:r+"open",class_search_wrapper:r+"search-wrapper",class_search:r+"search",class_options_wrapper:r+"options-wrapper",class_option:r+"option",class_option_checked:r+"option-checked",class_wrap_selected:r+"wrap",class_mobile:r+"mobile"},t={maxDisplay:3,onChange:null,onOpen:null,onClose:null};b=c.extend(t,b);var u=e(),v=p.attr("id"),w=p.attr("class"),x="Search...",y=c("<div id='"+v+"' class='"+w+" "+q+"'><div class='"+s.class_selected+"'><span class='"+s.class_wrap_selected+"'>"+x+"</span></div><div class='"+s.class_popup+"'><div class='"+s.class_search_wrapper+"'><input type='text' class='"+s.class_search+"' placeholder=''/></div><div class='"+s.class_options_wrapper+"'></div></div></div>");p.after(y);var z=y,A=z.find("."+s.class_selected),B=z.find("."+s.class_wrap_selected),C=z.find("."+s.class_popup),D=z.find("."+s.class_search),E=z.find("."+s.class_options_wrapper);p.addClass(q),p.addClass(s.class_mobile),z.removeClass("form-control"),p.on("change",function(){u=f(p.val()),d(),c.isFunction(b.onChange)&&b.onChange(k())}),d(),c("html").click(function(){h()}),z.click(function(){event.stopPropagation()}),A.click(function(){g()}),D.keyup(function(){n()})}}var e=function(a,e,f){function g(){f.allowDuplicates||c("#"+e).remove();var a,b,d,g={},a=c("<div id='"+e+"'></div>").appendTo(f.container);if(f.modal===!0){a.addClass(q.picker_modal_class);var b=c("<div class='"+q.picker_class+"'></div>").appendTo(a),d=c("<div class='"+q.picker_overlay_class+"'></div>").appendTo(a);a.css({position:"fixed","z-index":q.zindex,top:"0px",left:"0px",bottom:"0px",right:"0px",height:"100%",width:"100%","overflow-y":"auto","overflow-x":"hidden"}),d.css({position:"fixed","z-index":q.zindex+1,top:"0px",left:"0px",bottom:"0px",right:"0px",height:"100%",width:"100%"}),b.css({position:"absolute","z-index":q.zindex+2}),g.element=a,g.overlay=d,g.picker=b}else a.addClass(q.picker_class),a.addClass(q.picker_static_class),a.css({position:"absolute","z-index":Math.round(q.zindex/2)}),g.element=g.picker=a;f.draggable&&g.element.addClass(q.picker_draggable_class);for(var h=["width","height"],i=h.length-1;i>=0;i--){var j=h[i];"undefined"!==c.type(f[j])&&"null"!==c.type(f[j])&&"auto"!==f[j]&&g.picker.css(j,f[j])}if("array"===c.type(f.extraClass))for(var i=f.extraClass.length-1;i>=0;i--){var k=f.extraClass[i];g.picker.addClass(k)}else"string"===c.type(f.extraClass)&&g.picker.addClass(f.extraClass);if(f.transition&&(g.picker.addClass(f.transition),g.element.addClass(f.transition)),f.closeButton){var l=c("<div class='"+q.close_button_class+"' "+q.picker_close_attr+">&times;</div>").appendTo(g.picker);g.close_button=l}var m=c("<div class='"+q.content_class+"'></div>").appendTo(g.picker);if(g.content=m,f.confirmButton===!0||"string"===c.type(f.confirmButton)){var n="string"===c.type(f.confirmButton)?f.confirmButton:"OK",o=c("<div class='"+q.picker_footer_class+"'><button class='btn btn-default "+q.ok_button_class+"' "+q.picker_ok_attr+">"+n+"</button></div>").appendTo(g.picker);g.confirm_button=o}return g}function h(){var a=p.elements;void 0!==a&&"undefined"!==c.type(a.overlay)&&f.clickOverlay&&a.overlay.unbind("click")}function i(){var a=p.elements;void 0!==a&&"undefined"!==c.type(a.overlay)&&f.clickOverlay&&a.overlay.bind("click",function(){p.hide()})}function j(){var a=p.elements;void 0!==a&&(i(),c(a.picker).find("["+q.picker_close_attr+"]").click(function(){p.hide()}),c(a.picker).find("["+q.picker_ok_attr+"]").click(function(){var a=m();s.trigger("onSet",a),p.hide()}),f.draggable===!0&&o(a.picker))}function k(){}function l(a){p.state={selected:a}}function m(){return p.state}function n(a){console.log("smartPicker: "+a)}function o(a){var b=null,d=function(d){var f=d.originalEvent,h=a.position();b=f.changedTouches?{x:f.changedTouches[0].pageX-h.left,y:f.changedTouches[0].pageY-h.top}:{x:f.pageX-h.left,y:f.pageY-h.top},c(document).bind("touchmove mousemove",e),c(document).bind("touchend touchcancel mouseup",g),a.children().bind("touchend touchcancel mouseup change",g)},e=function(d){d.preventDefault();var e,g,h=d.originalEvent;if(h.changedTouches?(e=h.changedTouches[0].pageY-b.y,g=h.changedTouches[0].pageX-b.x):(e=h.pageY-b.y,g=h.pageX-b.x),a.hasClass(q.picker_static_class))var i=c(document).outerHeight()-a.outerHeight(),j=c(document).outerWidth()-a.outerWidth(),k=0,l=0;else var i=c(window).outerHeight()-a.outerHeight(),j=c(window).outerWidth()-a.outerWidth()+a.outerWidth()/2,k=0,l=a.outerWidth()/2;e=e>i?i:e,g=g>j?j:g,e=k>e?k:e,g=l>g?l:g,a.css({top:e,left:g}),f.top=e,f.left=g,f.bottom="auto",f.right="auto"},g=function(){c(document).unbind("touchmove mousemove"),c(document).unbind("touchend touchcancel mouseup"),a.children().unbind("touchend touchcancel mouseup")};a.bind("touchstart mousedown",d)}var p=this;p.type=a,p.id=e,p.options=f,p.state={};var q={picker_class:"picker-picker",picker_modal_class:"picker-modal",picker_overlay_class:"picker-overlay",picker_draggable_class:"picker-draggable",picker_static_class:"picker-static",picker_footer_class:"picker-footer",close_button_class:"picker-close-button",ok_button_class:"picker-ok-button",content_class:"picker-content",possible_types:["select","list","mult"],default_type:"select",possible_transitions:["no-transition","fade","slide","slideUp","slideRight","slideLeft"],default_transition:"slide",picker_close_attr:"data-picker-close",picker_ok_attr:"data-picker-ok",selectable_attr:"data-picker-selectable",value_attr:"data-picker-value",zindex:9e3},r={top:"50px",left:"auto",bottom:"auto",right:"auto",width:"260px",height:"auto",transition:q.default_transition,container:"body",closeButton:!1,confirmButton:!1,clickOverlay:!0,modal:!0,draggable:!1,"static":!1,allowDuplicates:!1,beforeShow:void 0,afterShow:void 0,beforeHide:void 0,afterHide:void 0,onInteraction:void 0,onSet:void 0,initialValue:void 0,contentData:void 0,contentTemplate:void 0,contentScript:void 0};f=p.options=c.extend(r,p.options),-1===q.possible_types.indexOf(p.type)&&(n("Type not supported. Switching to '"+q.default_type+"'"),p.type=q.default_type),-1===q.possible_transitions.indexOf(p.options.transition)&&(n("Transition not supported. Switching to '"+q.default_transition+"'"),p.options.transition=q.default_transition),c(f.container).length<1&&(n("Selected container '"+p.options.container+"' does not exist. Switching to 'body'"),p.options.container="body"),f=p.options=c.extend(r,p.options),a=p.type;var s=p.events={events:{},bind:function(a,b){"array"!==c.type(this.events[a])&&(this.events[a]=[]),c.isFunction(b)?this.events[a].push(b):n("Can't bind '"+b+"' to event '"+a+"'. It must be a function!")},trigger:function(a,b){if("undefined"!==c.type(this.events[a]))for(var d=0,e=this.events[a].length;e>d;d++){var f=this.events[a][d];c.isFunction(f)?"undefined"===c.type(b)?f():f(b):n("Can't execute '"+func+"' on event '"+a+"'. It must be a function!")}}},t={parse:function(a,d){var e=b.template(a,d);return"function"===c.type(e)?e():e},build:function(a,d,e,f,g){d=d||{};var h,i;switch(a){case"mult":if(d=b.extend({text:"",options:[]},d),g&&b.isArray(g)){var j=g,k=[];b.each(d.options,function(a){-1!==b.indexOf(j,a.value)?(a.selected=!0,k.push(a)):a.selected=!1}),l(k)}h=this.templates.select_mult,i=this.functions.select_mult;break;case"list":d=b.extend({text:"",options:[{value:"",name:"Choose...",selected:!0}]},d),h=this.templates.one_from_list,i=this.functions.one_from_list;break;case"select":default:d=b.extend({text:"",options:[{value:"",name:"Choose...",selected:!0}]},d),h=this.templates.select_one,i=this.functions.select_one}return"string"!==c.type(e)&&(e=h),"function"!==c.type(f)&&(f=i),{markup:this.parse(e,d),postRender:f}},templates:{html:"<div><%= text %></div>",select_one:"<h4><%= text %></h4><div><select class='form-control' id='picker_selector'><% _.each(options, function(opt) { %><option value='<%= opt.value %>' <%= (opt.selected) ? 'selected' : '' %>><%= opt.name %></option><% }); %></select></div>",select_mult:"<h4><%= text %></h4><div><select id='picker_selector' class='form-control' multiple='multiple'><% _.each(options, function(opt) { %><option value='<%= opt.value %>' <%= (opt.selected) ? 'selected' : '' %>><%= opt.name %></option><% }); %></select></div>",one_from_list:"<h4 align='center'><%= text %></h4><div><div id='picker_selector' class='btn-group-vertical' "+q.selectable_attr+"><% _.each(options, function(opt) { %><button "+q.value_attr+"='<%= opt.value %>' class='btn btn-default btn-block <%= (opt.selected) ? 'active' : '' %>'><%= opt.name %></button><% }); %></div></div>"},functions:{select_one:function(a){a.find("#picker_selector").on("change",function(){var b=a.find("#picker_selector").val();l(b),s.trigger("onInteraction",m())})},select_mult:function(a){var b=a.find("#picker_selector");d(b,{onChange:function(a){l(a),s.trigger("onInteraction",m())},onOpen:function(){h()},onClose:function(){i()}})},one_from_list:function(a){var b=a.find("#picker_selector"),d=b.find("button");d.each(function(){var a=c(this);a.on("click",function(){d.removeClass("active"),a.addClass("active");var c=a.attr(q.value_attr);b.attr(q.selectable_attr,c),l(c),s.trigger("onInteraction",m())})})}}};p.content=t.build(a,f.contentData,f.contentTemplate,f.contentScript,f.initialValue),p.show=function(){s.trigger("beforeShow"),p.bindElements(),p.elements.element.css("display","block");var a,b,d,e,g,h,i,j;f.modal===!0?(a=g=0,d=i=p.elements.picker.outerWidth()/2,b=h=c(window).outerHeight()-p.elements.picker.outerHeight(),e=j=c(window).outerWidth()-p.elements.picker.outerWidth()+d):(a=d=g=i=0,b=h=c(document).outerHeight()-p.elements.picker.outerHeight(),e=j=c(document).outerWidth()-p.elements.picker.outerWidth());var k="auto"===f.top?f.top:f.top>b?b:f.top<a?a:f.top,l="auto"===f.left?f.left:f.left>e?e:f.left<d?d:f.left,m="auto"===f.right?f.right:f.right>j?j:f.right<i?i:f.right,n="auto"===f.bottom?f.bottom:f.bottom>h?h:f.bottom<g?g:f.bottom;if(p.elements.picker.css({top:k,right:m,bottom:n,left:l}),f.modal===!0){{var o=p.elements.picker.outerWidth();p.elements.picker.outerWidth()}"auto"===f.left&"auto"===f.right&&p.elements.picker.css({left:"50%","margin-left":-(o/2)+"px"})}p.elements.element.addClass("visible"),s.trigger("afterShow")},p.bindElements=function(){if(b.isUndefined(p.elements)){p.elements=g(),j();var a=p.elements.content;a.html(p.content.markup),"function"===c.type(p.content.postRender)&&p.content.postRender(a)}},p.hide=function(){if(!b.isUndefined(p.elements)){s.trigger("beforeHide"),p.elements.element.removeClass("visible");var a="no-transition"===f.transition?0:500,c=setInterval(function(){p.elements.element.css("display","none"),k(),s.trigger("afterHide"),clearInterval(c)},a)}},p.clear=function(){c("#"+p.id).remove(),b.each(p.elements,function(a){a.remove()}),p.elements=void 0},p.resetValue=function(b){p.clear(),f.initialValue=b,p.content=t.build(a,f.contentData,f.contentTemplate,f.contentScript,f.initialValue)},p.resetData=function(c){p.clear(),f.contentData=c;var d=m().selected;d=b.map(d,function(a){return a.value}),f.initialValue=d,p.content=t.build(a,f.contentData,f.contentTemplate,f.contentScript,f.initialValue)},p.onSet=function(){var a=m();s.trigger("onSet",a)},p.onInteraction=function(){var a=m();s.trigger("onInteraction",a)};for(var u=["beforeShow","afterShow","beforeHide","afterHide","onInteraction","onSet"],v=u.length-1;v>=0;v--){var w=u[v];"function"===c.type(f[w])&&s.bind(w,f[w])}return p};return e});